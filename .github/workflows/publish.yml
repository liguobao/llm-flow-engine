name: Publish to PyPI

on:
  release:
    types: [published]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  publish:
    runs-on: ubuntu-latest
    environment: release  # ä½¿ç”¨çŽ¯å¢ƒä¿æŠ¤è§„åˆ™
    
    steps:
    - name: ðŸ›Žï¸ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: ðŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build twine
        pip install -r requirements.txt
        
    - name: ðŸ” Run tests
      run: |
        if [ -f "validate_project.py" ]; then
          python validate_project.py
        fi
        
    - name: ðŸ”¨ Build package
      run: python -m build
      
    - name: ðŸ” Check package
      run: python -m twine check dist/*
      
    - name: ðŸš€ Publish to PyPI
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
      run: python -m twine upload dist/*
      
    - name: ðŸ“ Create release notes
      run: |
        VERSION=$(python -c "import re; content=open('pyproject.toml').read(); print(re.search(r'version\s*=\s*[\"\'](.*?)[\"\']', content).group(1))")
        echo "# Release v${VERSION}" > release_notes.md
        echo "" >> release_notes.md
        echo "ðŸŽ‰ Successfully published to PyPI!" >> release_notes.md
        echo "" >> release_notes.md
        echo "## ðŸ“¦ Installation" >> release_notes.md
        echo "\`\`\`bash" >> release_notes.md
        echo "pip install llm-flow-engine==${VERSION}" >> release_notes.md
        echo "\`\`\`" >> release_notes.md
        echo "" >> release_notes.md
        echo "## ðŸ”— Links" >> release_notes.md
        echo "- [PyPI Package](https://pypi.org/project/llm-flow-engine/${VERSION}/)" >> release_notes.md
        echo "- [GitHub Release](https://github.com/liguobao/llm-flow-engine/releases/tag/v${VERSION})" >> release_notes.md
      env:
        PYTHONIOENCODING: utf-8
        
    - name: ðŸ“¤ Upload release notes
      uses: actions/upload-artifact@v3
      with:
        name: release-notes
        path: release_notes.md
